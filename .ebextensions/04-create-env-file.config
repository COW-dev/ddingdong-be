container_commands:
  01_create_env_file:
    command: |
      #!/bin/bash

      # .env 파일 생성 위치
      ENV_FILE="/var/app/current/.env"

      # 기존 .env 파일 백업 (있다면)
      if [ -f "$ENV_FILE" ]; then
        cp "$ENV_FILE" "${ENV_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
      fi

      # EB 환경변수를 JSON으로 가져와서 .env 형식으로 변환
      /opt/elasticbeanstalk/bin/get-config environment | \
        jq -r 'to_entries | .[] | "\(.key)=\(.value)"' > "$ENV_FILE"

      # 권한 설정
      chmod 600 "$ENV_FILE"
      chown webapp:webapp "$ENV_FILE"

      echo "Created .env file with $(wc -l < $ENV_FILE) environment variables"
    leader_only: true
