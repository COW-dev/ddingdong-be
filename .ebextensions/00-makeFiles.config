files:
    "/sbin/appstart" :
        mode: "000755"
        owner: webapp
        group: webapp
        content: |
            #!/usr/bin/env bash

            ENV_FILE="/var/app/current/.env"
            /opt/elasticbeanstalk/bin/get-config environment | \
              jq -r 'to_entries | .[] | "\(.key)=\(.value)"' > "$ENV_FILE"
            chmod 600 "$ENV_FILE"
            chown webapp:webapp "$ENV_FILE"

            JAR_PATH=/var/app/current/application.jar
            AGENT_PATH=/var/app/current/otel/opentelemetry-javaagent.jar
            LOG_DIR=/var/app/current/logs/gc
            mkdir -p $LOG_DIR

            mkdir -p /var/app/current/otel
            if [ -f /var/app/staging/otel/opentelemetry-javaagent.jar ]; then
                cp /var/app/staging/otel/opentelemetry-javaagent.jar $AGENT_PATH
            fi

            # run app
            killall java
            java \
              -javaagent:$AGENT_PATH \
              -Dfile.encoding=UTF-8 \
              -Xms512m -Xmx512m \
              -Xlog:gc*,gc+humongous=debug:file=$LOG_DIR/gc.log:time,uptime,level,tags:filecount=5,filesize=100M \
              -XX:+HeapDumpOnOutOfMemoryError \
              -XX:HeapDumpPath=$LOG_DIR/heapdump.hprof \
              -XX:ConcGCThreads=2 \
              -XX:G1HeapRegionSize=2m \
              -XX:MaxNewSize=128m \
              -jar $JAR_PATH
